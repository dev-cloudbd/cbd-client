<!doctype refentry PUBLIC "-//OASIS//DTD DocBook V4.1//EN" [

<!-- Process this file with docbook-to-man to generate an nroff manual
     page: `docbook-to-man manpage.sgml > manpage.1'.  You may view
     the manual page with: `docbook-to-man manpage.sgml | nroff -man |
     less'.  A typical entry in a Makefile or Makefile.am is:

manpage.1: manpage.sgml
	docbook-to-man $< > $@
  -->

  <!-- Fill in your name for FIRSTNAME and SURNAME. -->
  <!ENTITY dhfirstname "<firstname>Shaun</firstname>">
  <!ENTITY dhsurname   "<surname>McDowell</surname>">
  <!-- Please adjust the date whenever revising the manpage. -->
  <!ENTITY dhdate      "<date>$Date: 2018-11-17 15:00:00 -0500 $</date>">
  <!-- SECTION should be 1-8, maybe w/ subsection other parameters are
       allowed: see man(7), man(1). -->
  <!ENTITY dhsection   "<manvolnum>5</manvolnum>">
  <!ENTITY dhemail     "<email>smcdowell@cloudbd.io</email>">
  <!ENTITY dhusername  "Shaun McDowell">
  <!ENTITY dhucpackage "<refentrytitle>CBDTAB</refentrytitle>">
  <!ENTITY dhpackage   "$sysconfdir/cloudbd/cbdtab">
]>

<refentry>
  <refentryinfo>
    <address>
      &dhemail;
    </address>
    <author>
      &dhfirstname;
      &dhsurname;
    </author>
    <copyright>
      <year>2018</year>
      <holder>CloudBD, LLC</holder>
    </copyright>
    &dhdate;
  </refentryinfo>
  <refmeta>
    &dhucpackage;

    &dhsection;
  </refmeta>
  <refnamediv>
    <refname>&dhpackage;</refname>

    <refpurpose>configuration file for CloudBD disks</refpurpose>
  </refnamediv>
  <refsynopsisdiv>
    <cmdsynopsis>
      <command>&dhpackage; </command>

    </cmdsynopsis>
  </refsynopsisdiv>
  <refsect1>
    <title>DESCRIPTION</title>

    <para>This file configures which CloudBD disks attach to this
      server. It may contain multiple definitions, one per line,
      each of which contains three space separate fields.</para>

    <para>Fields are separated from one another by any number of space
      or tab characters; records are separated from one another by
      newline characters. The file may also contain any number of
      comments, which start with a '#' character and continue until the
      end of the line or the end of the file, whichever is first.</para>
    <refsect2>
      <title>Fields</title>
      <para>Each record contains the following fields: &lt;nbd&gt;,
        &lt;remote&gt;:&lt;disk&gt;, and [driver settings]</para>
      <orderedlist>
        <listitem>
          <para>&lt;nbd&gt;  The short name of an available nbd device.</para>
          <para>The default nbd kernel module settings will create 16 nbd
            devices at <filename>/dev/nbd[0-15]</filename>. This field should
            contain the short name of an unused nbd device without the leading
            <filename>/dev/</filename> part; e.g., it could say
            <filename>nbd0</filename>.</para>
        </listitem>
        <listitem>
          <para>&lt;remote&gt;:&lt;disk&gt;  The remote and disk names.</para>
          <para>The remote name is the filename of your storage remote config file
            in the remotes.d directory without the '.conf' extension; e.g.,
            <filename>/etc/cloudbd/remotes.d/&lt;remote&gt;.conf</filename>.
            For a list of configured remotes run <command>cloudbd
            ls</run>.</para>
          <para>The disk name is the name of a CloudBD disk stored on
            &lt;remote&gt;. For a list of disks on the remote run
            <command>cloudbd ls &lt;remote&gt;</command>.</para>
        </listitem>
        <listitem>
          <para>[driver settings]  The driver settings.</para>
          <para>This field is optional and need not appear in a file if no
            driver tuning is necessary. The settings recognized are
            specified below in the section "Driver Settings".</para>
        </listitem>
      </orderedlist>
    </refsect2>
    <refsect2>
      <title>Driver Settings</title>

      <para>Individual options in this field should be separated from
        one another by the comma character without spaces.
        Settings that require a value are specified using
        &lt;key&gt;=&lt;value&gt; notation.</para>

      <para>The Profile options (e.g., defaults, lowmem, and highperf) will
        set a group of options that work well together for good performance
        vs driver memory usage. The group settings were chosen by
        performance testing on various AWS EC2 instances using S3 with
        ops that had between 75ms and 125ms latency. For your specific
        deployment, further tuning may be required.</para>

      <para>Options that come latter take precedence and override earlier
        settings; e.g., if you using driver settings "lowmem,block_buffers=32",
        the driver will use the lowmem settings except block_buffers will be
        set to 32.</para>

      <variablelist>
        <varlistentry>
          <term><option>defaults</option></term>
          <listitem>
            <para>The default settings profile. Recommended for servers with
            up to 10 gigabit networking and at least 4 GB of memory.</para>
            <para>block_buffers=48,cache_buffers=16,threads=2,readahead=64,requests=64</para>
          </listitem>
        </varlistentry>
        <varlistentry>
          <term><option>lowmem</option></term>
          <listitem>
            <para>Settings profile for reduced memory and network usage.
              Recommended for servers with low memory or limited network
              capabilities.</para>
            <para>block_buffers=16,cache_buffers=8,threads=1,readahead=16,requests=32</para>
          </listitem>
        </varlistentry>
        <varlistentry>
          <term><option>highperf</option></term>
          <listitem>
            <para>Settings profile for high performance. Recommended for servers
              with up to 25 Gigabit networking and at least 8GB of memory. The
              driver will use additional memory and network connections for
              very high performance (up to 2.2GiB/s).</para>
            <para>block_buffers=128,cache_buffers=24,threads=4,readahead=256,requests=128</para>
          </listitem>
        </varlistentry>
        <varlistentry>
          <term><option>block_buffers=<replaceable>number</replaceable></option></term>
          <listitem>
            <para>The number of block buffers to use for this disk. The disk
              is split into many atomic block sized chunks and this setting
              controls how many blocks the driver can have in memory for reads
              and writes at once. Defaults to 48.</para>
          </listitem>
        </varlistentry>
        <varlistentry>
          <term><option>cache_buffers=<replaceable>number</replaceable></option></term>
          <listitem>
            <para>The number of cached partial write buffers to use. When
              partial block writes occur there is a high probability of another
              read or write operation soon after to the same block. This
              setting controls the number of recent partial write block_buffers
              to keep in memory to accelerate future write ops from becoming
              read-modify-write ops. Defaults to 16.</para>
          </listitem>
        </varlistentry>
      </variablelist>
    </refsect2>
    <refsect2>
      <title>Upstart/SysVinit</title>

      <para>On systems using Upstart or SysVinit, CloudBD disks specified in
        <filename>cbdtab</filename> are automatically started at boot by the
        cbddisks service.</para>

      <para>To start all CloudBD disks specified in
        <filename>cbdtab</filename>, run
        <command>service cbddisks start</command>.</para>

      <para>To stop all running CloudBD disks, run
        <command>service cbddisks stop</command>.</para>

      <para>To start and stop individual CloudBD disks, see Manual
        Starting and Stopping below.</para>
    </refsect2>
    <refsect2>
      <title>Systemd</title>

      <para>On systems using Systemd, CloudBD disks specified in
        <filename>cbdtab</filename> are automatically started at boot by
        generated service files for each disk and the
        <filename>cbdsetup.target</filename>.</para>

      <para>When editing the <filename>cbdtab</filename> file, you must run
        <command>systemctl daemon-reload</command> afterwards to update the
        generated systemd service files for your disks.</para>

      <para>To start all CloudBD disks specified in
        <filename>cbdtab</filename>, run <command>systemctl start
        cbdsetup.target</command> or <command>systemctl start
        cbdsetup@*.service</command>.</para>

      <para>To stop all running CloudBD disks, run
        <command>systemctl stop cbdsetup@*.service</command>.</para>

      <para>To start an individual CloudBD disk specified in
        <filename>cbdtab</filename>, run <command>systemctl start
        cbdsetup@&lt;remote&gt;:&lt;disk&gt;.service</command>.</para>

      <para>To stop an individual running CloudBD disk, run <command>systemctl
        stop cbdsetup@&lt;remote&gt;:&lt;disk&gt;.service</command>.</para>
    </refsect2>
    <refsect2>
      <title>Manual Starting and Stopping</title>

      <para>To manually start a CloudBD disk specified in the cbdtab file, run
        <command>cbddisks_start</command> with the &lt;remote&gt;:&lt;disk&gt;
        as the sole argument. It will then look up the required information in
        <filename>cbdtab</filename>, and attach the disk at
        <filename>/dev/mapper/&lt;remote&gt;:&lt;disk&gt;</filename>.</para>

      <para>To manually stop a running CloudBD disk, run
        <command>cbddisks_stop</command> with the &lt;remote&gt;:&lt;disk&gt;
        as the sole argument. If the disk is busy or in use, use the -f option
        to force the disk to stop.</para>
    </refsect2>
  </refsect1>
  <refsect1>
    <title>SEE ALSO</title>

    <para>The CloudBD documentation pages at
      https://www.cloudbd.io/docs.</para>

  </refsect1>
  <refsect1>
    <title>AUTHOR</title>

    <para>This manual page was written by &dhusername; (&dhemail;).
      Permission is granted to copy, distribute and/or modify this
      document under the terms of the <acronym>GNU</acronym> General
      Public License, version 2, as published by the Free Software
      Foundation.</para>

  </refsect1>
  <refsect1>
    <title>EXAMPLES</title>
    <para>A simple <filename>cbdtab</filename> file could look like
    this:</para>
    <programlisting>
# &lt;nbd&gt;     &lt;remote&gt;:&lt;disk&gt;             [driver settings]
nbd0        my_remote_1:example_disk1   # no options set, will use defaults
nbd1        my_remote_1:example_disk2   lowmem   # reduced settings
nbd2        my_remote_2:example_disk3   highperf # high performance settings
nbd3        my_remote_2:example_disk4   defaults,block_buffers=32,readahead=16
    </programlisting>
  </refsect1>
</refentry>
